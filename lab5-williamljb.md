# lab5 报告

## 练习题
### 练习一 加载应用程序并执行
---

实现过程：把tf的各个成员变量设置好即可。具体地，tf的cs段为用户代码段，ds、es、ss段为用户数据段，
eip为程序开头，esp为用户栈顶，eflags允许中断。

和答案不一样的是，一开始设置eflags我用了|=，其实只要直接赋值即可。上面的memset已经把tf清零了。

问题回答：做了switch_to之后，返回到了fortret函数，以里面的tf为参数调用fortrets，
之后回去到了iret之后就会使用这个tf来返回到tf指向的地方。
刚才初始化的时候把tf设置成了用户态的段，那么回去之后就会变成用户态的程序，然后开始执行。

---

### 练习二 父进程复制自己的内存空间给子进程
---

实现过程：按照注释，找到src和dst的kvaddr，然后对其进行复制，大小为一个页。
再用page_insert来修改页表的映射关系即可。

和答案不一样的是，一开始不知道la以及perm应该是什么。后来发现上面已经设置好了perm，
然后la指的是线性地址，在每个循环中都是处理以start开头的那一页，所以就是start。

问题回答：在dup_mmap中复制mm_struct的时候，直接复制vma的指针过去，
相当于两个mm_struct共享同一份vma列表，并让这些vma只读。
然后发现缺页的时候，如果检测到在尝试写一个只读页，那么说明这里有多个进程在共用这个vma，
这个时候再去新建一个vma并用copy_range复制数据，同时修改相应的mm_struct即可。

---

### 练习三 阅读分析源代码，理解进程执行 fork/exec/wait/exit 的实现，以及系统调用的实现
---

fork：创建一个新的进程，把父进程的当前状态复制之后，令新的进程状态为RUNNABLE。
exec：通过一个load_icode，把新的程序复制进来，再去执行。如果load_icode失败，则会调用do_exit退出。
wait：如果找到了符合条件的子进程，则回收子进程的资源并正常返回；否则如果子进程正在运行，
则通过schedule让自己变为SLEEPING的，等到下次被唤醒的时候再去寻找子进程。
exit：首先回收大部分资源，并把自己变成ZONBIE状态，然后查看父进程，如果在等待状态，则唤醒父进程；
接着遍历自己的子进程，把他们的父进程均设置为initproc，如果子进程有ZOMBIE状态且initproc为等待状态则唤醒initproc。
最后通过schedule调度其他进程执行。

-----------------------------
                                            
  alloc_proc                                 RUNNING
      +                                   +--<----<--+
      +                                   + proc_run +
      V                                   +-->---->--+ 
PROC_UNINIT -- proc_init/wakeup_proc --> PROC_RUNNABLE -- try_free_pages/do_wait/do_sleep --> PROC_SLEEPING --
                                           A      +                                                           +
                                           |      +--- do_exit --> PROC_ZOMBIE                                +
                                           +                                                                  + 
                                           -----------------------wakeup_proc----------------------------------
-----------------------------

---

---


### 重要的知识点
---

实验中do_exit的处理在原理课中并没有详细说明。
原理课中讲到关于进程的有关知识除了基本的概念之外大部分都是直接介绍ucore的具体实现，
故也没有明显的没有在实验中出现的知识点。

---

